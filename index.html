<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>訪問看護ステーション向け 電子カルテ デモ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f7;
      color: #222;
    }
    body { min-height: 100vh; }

    header {
      background: #1976d2;
      color: #fff;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .nav-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }
    header .user-info {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    header button {
      background: rgba(255,255,255,0.12);
      border: none;
      color: #fff;
      padding: 4px 10px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 12px;
      white-space: nowrap;
    }
    header button:hover {
      background: rgba(255,255,255,0.25);
    }
    header button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    main {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }

    .view {
      display: none;
      background: #fff;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(15,23,42,0.1);
      margin-bottom: 24px;
    }
    .view.active { display: block; }

    h2 { font-size: 18px; margin: 0 0 12px; }
    h3 { font-size: 16px; margin: 16px 0 8px; }

    .form-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 12px;
    }
    .form-field {
      flex: 1 1 200px;
      display: flex;
      flex-direction: column;
      font-size: 13px;
    }
    .form-field label {
      margin-bottom: 4px;
      font-weight: 600;
    }
    .form-field input,
    .form-field select,
    .form-field textarea {
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 13px;
    }
    .form-field textarea {
      min-height: 80px;
      resize: vertical;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
    }
    .btn.secondary {
      background: #e0e0e0;
      color: #111;
    }
    .btn.small {
      padding: 4px 8px;
      font-size: 12px;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: default;
    }
    .btn + .btn { margin-left: 8px; }

    .table-wrapper {
      overflow-x: auto;
      margin-top: 8px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      border-bottom: 1px solid #e0e0e0;
      padding: 6px 8px;
      text-align: left;
      white-space: nowrap;
    }
    th { background: #f3f4f6; }
    tr:hover { background: #f9fafb; }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      background: #e3f2fd;
      color: #1565c0;
    }

    .tabs {
      display: flex;
      border-bottom: 1px solid #e0e0e0;
      margin-bottom: 8px;
      overflow-x: auto;
    }
    .tab {
      padding: 6px 12px;
      cursor: pointer;
      font-size: 13px;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }
    .tab.active {
      border-bottom-color: #1976d2;
      font-weight: 600;
      color: #1976d2;
    }

    .small-text { font-size: 11px; color: #666; }
    .error-text { color: #d32f2f; font-size: 12px; margin-top: 4px; }
    .section-divider { border-top: 1px dashed #ddd; margin: 16px 0; }

    #view-login {
      max-width: 400px;
      margin: 40px auto;
    }

    @media (max-width: 768px) {
      header { flex-direction: column; align-items: flex-start; }
      main { padding: 8px; }
      th, td { padding: 4px 6px; }
    }
  </style>

  <!-- Chart.js（バイタルグラフ用。読み込めなくても致命傷にはならない） -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body>
<header>
  <div class="header-left">
    <h1>訪問看護 電子カルテ デモ</h1>
    <div class="nav-buttons">
      <button id="nav-dashboard-btn" disabled>ダッシュボード</button>
      <button id="nav-patients-btn" disabled>利用者一覧</button>
      <button id="nav-schedule-btn" disabled>本日の訪問</button>
    </div>
  </div>
  <div class="user-info" id="user-info">
    未ログイン
    <button id="logout-btn" style="display:none;">ログアウト</button>
  </div>
</header>

<main>
  <!-- ログイン画面 -->
  <section class="view active" id="view-login">
    <h2>ログイン</h2>
    <p class="small-text">
      デモ用のため、メールアドレスとパスワードを両方入力すればログインできます。<br />
      （実運用時はバックエンド側で認証を実装します）
    </p>
    <form id="login-form">
      <div class="form-row">
        <div class="form-field">
          <label for="login-email">メールアドレス</label>
          <input type="email" id="login-email" required placeholder="nurse@example.com" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label for="login-password">パスワード</label>
          <input type="password" id="login-password" required placeholder="任意の文字列" />
        </div>
      </div>
      <button type="submit" class="btn" id="login-submit-btn">ログイン</button>
      <div id="login-error" class="error-text" style="display:none;"></div>
    </form>
  </section>

  <!-- ダッシュボード -->
  <section class="view" id="view-dashboard">
    <h2>ダッシュボード</h2>
    <p class="small-text">
      本日の訪問予定と、よく使う画面へのショートカットです。
    </p>
    <div class="form-row">
      <button class="btn secondary" id="nav-dashboard-to-patients">利用者一覧へ</button>
      <button class="btn secondary" id="nav-dashboard-to-schedule">本日の訪問へ</button>
    </div>
    <div class="section-divider"></div>
    <h3>本日の訪問予定</h3>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>時間</th>
          <th>利用者</th>
          <th>種別</th>
          <th>担当</th>
          <th>状態</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="dashboard-visits-body"></tbody>
      </table>
    </div>
  </section>

  <!-- 利用者一覧 -->
  <section class="view" id="view-patients">
    <h2>利用者一覧</h2>
    <p class="small-text">
      氏名クリックで、利用者詳細（訪問予定・記録・バイタル）に移動します。
    </p>
    <div class="form-row">
      <div class="form-field">
        <label for="patient-search">検索（氏名）</label>
        <input id="patient-search" type="text" placeholder="例）山田" />
      </div>
      <div class="form-field" style="align-self:flex-end;">
        <button class="btn" id="btn-new-patient">新規利用者登録</button>
      </div>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>氏名</th>
          <th>生年月日</th>
          <th>性別</th>
          <th>電話</th>
        </tr>
        </thead>
        <tbody id="patients-table-body"></tbody>
      </table>
    </div>

    <div class="section-divider"></div>
    <h3 id="patient-form-title">新規利用者登録</h3>
    <form id="patient-form">
      <input type="hidden" id="patient-id" />
      <div class="form-row">
        <div class="form-field">
          <label>姓</label>
          <input id="patient-last-name" required />
        </div>
        <div class="form-field">
          <label>名</label>
          <input id="patient-first-name" required />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>生年月日</label>
          <input type="date" id="patient-birth-date" />
        </div>
        <div class="form-field">
          <label>性別</label>
          <select id="patient-sex">
            <option value="">未選択</option>
            <option value="M">男性</option>
            <option value="F">女性</option>
            <option value="U">その他</option>
          </select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>電話番号</label>
          <input id="patient-phone" />
        </div>
        <div class="form-field">
          <label>住所</label>
          <input id="patient-address" />
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>メモ</label>
          <textarea id="patient-notes" placeholder="既往歴、家族構成、生活状況など"></textarea>
        </div>
      </div>
      <button type="submit" class="btn" id="patient-save-btn">保存</button>
      <button type="button" class="btn secondary" id="patient-reset-btn">クリア</button>
    </form>
  </section>

  <!-- 利用者詳細 -->
  <section class="view" id="view-patient-detail">
    <h2 id="patient-detail-name">利用者詳細</h2>
    <p class="small-text" id="patient-detail-basic"></p>
    <div class="tabs">
      <div class="tab active" data-tab="detail-visits">訪問/記録</div>
      <div class="tab" data-tab="detail-vitals">バイタル</div>
    </div>

    <div id="detail-visits" class="detail-tab" style="display:block;">
      <div class="form-row">
        <button class="btn" id="btn-new-visit">新規訪問予定</button>
      </div>
      <h3>訪問一覧</h3>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>日時</th>
            <th>種別</th>
            <th>担当</th>
            <th>状態</th>
            <th>操作</th>
          </tr>
          </thead>
          <tbody id="patient-visits-body"></tbody>
        </table>
      </div>

      <div class="section-divider"></div>
      <h3>訪問予定作成</h3>
      <form id="visit-form">
        <input type="hidden" id="visit-id" />
        <div class="form-row">
          <div class="form-field">
            <label>日付</label>
            <input type="date" id="visit-date" required />
          </div>
          <div class="form-field">
            <label>開始時刻</label>
            <input type="time" id="visit-start-time" required />
          </div>
          <div class="form-field">
            <label>終了時刻</label>
            <input type="time" id="visit-end-time" />
          </div>
          <div class="form-field">
            <label>種別</label>
            <select id="visit-type">
              <option value="regular">定期</option>
              <option value="oncall">オンコール</option>
              <option value="emergency">緊急</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>担当者</label>
            <input id="visit-nurse" placeholder="例）看護師A" />
          </div>
          <div class="form-field">
            <label>メモ</label>
            <input id="visit-memo" placeholder="例）創部処置・バイタルチェック" />
          </div>
        </div>
        <button type="submit" class="btn">訪問予定を保存</button>
        <button type="button" class="btn secondary" id="visit-reset-btn">クリア</button>
      </form>
    </div>

    <div id="detail-vitals" class="detail-tab" style="display:none;">
      <h3>バイタル推移</h3>
      <canvas id="vitals-chart" height="200"></canvas>
      <h3>バイタル記録追加</h3>
      <form id="vital-form">
        <div class="form-row">
          <div class="form-field">
            <label>測定日時</label>
            <input type="datetime-local" id="vital-datetime" required />
          </div>
          <div class="form-field">
            <label>体温 (℃)</label>
            <input type="number" step="0.1" id="vital-temp" />
          </div>
          <div class="form-field">
            <label>収縮期血圧</label>
            <input type="number" id="vital-bp-sys" />
          </div>
          <div class="form-field">
            <label>拡張期血圧</label>
            <input type="number" id="vital-bp-dia" />
          </div>
        </div>
        <div class="form-row">
          <div class="form-field">
            <label>脈拍 (bpm)</label>
            <input type="number" id="vital-pulse" />
          </div>
          <div class="form-field">
            <label>SpO₂ (%)</label>
            <input type="number" id="vital-spo2" />
          </div>
        </div>
        <button type="submit" class="btn">バイタルを追加</button>
      </form>
      <h3>最近のバイタル一覧</h3>
      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>日時</th>
            <th>体温</th>
            <th>血圧</th>
            <th>脈拍</th>
            <th>SpO₂</th>
          </tr>
          </thead>
          <tbody id="vitals-table-body"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- 訪問記録入力 -->
  <section class="view" id="view-visit-note">
    <h2>訪問看護記録入力</h2>
    <p class="small-text" id="visit-note-header"></p>
    <form id="visit-note-form">
      <div class="form-row">
        <div class="form-field">
          <label>主観的情報（S）</label>
          <textarea id="note-subjective" placeholder="例）昨夜はよく眠れたとのこと。"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>客観的情報（O）</label>
          <textarea id="note-objective" placeholder="バイタル・創部観察など"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>評価（A）</label>
          <textarea id="note-assessment"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>計画（P）</label>
          <textarea id="note-plan"></textarea>
        </div>
      </div>
      <div class="form-row">
        <div class="form-field">
          <label>自由記載（音声入力想定）</label>
          <textarea id="note-free" placeholder="音声入力から貼り付け可"></textarea>
        </div>
      </div>
      <button type="submit" class="btn">記録を保存</button>
      <button type="button" class="btn secondary" id="btn-note-back">戻る</button>
    </form>
  </section>

  <!-- 本日の訪問スケジュール -->
  <section class="view" id="view-schedule">
    <h2>本日の訪問スケジュール</h2>
    <p class="small-text" id="schedule-date-label"></p>
    <div class="table-wrapper">
      <table>
        <thead>
        <tr>
          <th>時間</th>
          <th>利用者</th>
          <th>種別</th>
          <th>担当</th>
          <th>状態</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="schedule-table-body"></tbody>
      </table>
    </div>
    <div style="margin-top:12px;">
      <button class="btn secondary" id="btn-schedule-back">ダッシュボードに戻る</button>
    </div>
  </section>
</main>

<script>
  // ======= データモデルとストレージ =======
  var STORAGE_KEY = "houkan_karte_simple_v2";

  function genId() {
    return "id-" + Math.random().toString(36).slice(2) + Date.now().toString(36);
  }

  function todayISODate() {
    return new Date().toISOString().slice(0, 10);
  }

  function createInitialState() {
    var patientId = genId();
    var visitId = genId();
    var now = new Date();
    var start = new Date();
    start.setHours(9, 0, 0, 0);
    var end = new Date();
    end.setHours(9, 40, 0, 0);

    return {
      patients: [
        {
          id: patientId,
          lastName: "山田",
          firstName: "太郎",
          birthDate: "1940-01-01",
          sex: "M",
          phone: "090-0000-0000",
          address: "東京都サンプル区1-1-1",
          notes: "糖尿病・褥瘡あり。ご家族同居。"
        }
      ],
      visits: [
        {
          id: visitId,
          patientId: patientId,
          startAt: start.toISOString(),
          endAt: end.toISOString(),
          type: "regular",
          nurse: "看護師A",
          status: "scheduled",
          memo: "創部処置・バイタルチェック"
        }
      ],
      vitals: [
        {
          id: genId(),
          patientId: patientId,
          visitId: visitId,
          measuredAt: new Date(now.getTime() - 86400000).toISOString(),
          temp: 36.7,
          bpSys: 128,
          bpDia: 78,
          pulse: 72,
          spo2: 97
        },
        {
          id: genId(),
          patientId: patientId,
          visitId: visitId,
          measuredAt: now.toISOString(),
          temp: 36.8,
          bpSys: 126,
          bpDia: 76,
          pulse: 70,
          spo2: 98
        }
      ],
      visitNotes: []
    };
  }

  function loadState() {
    try {
      var raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return createInitialState();
      var parsed = JSON.parse(raw);
      if (!parsed.vitals) parsed.vitals = [];
      if (!parsed.visitNotes) parsed.visitNotes = [];
      if (!parsed.visits) parsed.visits = [];
      if (!parsed.patients) parsed.patients = [];
      return parsed;
    } catch (e) {
      console.error("failed to load state", e);
      return createInitialState();
    }
  }

  function saveState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
  }

  var appState = loadState();
  var currentUser = null;
  var currentPatientId = null;
  var currentVisitId = null;
  var vitalsChart = null;

  // ======= 共通ユーティリティ =======
  function showView(id) {
    var views = document.getElementsByClassName("view");
    for (var i = 0; i < views.length; i++) {
      views[i].classList.remove("active");
    }
    var t = document.getElementById(id);
    if (t) t.classList.add("active");
  }

  function updateHeader() {
    var userInfo = document.getElementById("user-info");
    var logoutBtn = document.getElementById("logout-btn");
    var navDashboard = document.getElementById("nav-dashboard-btn");
    var navPatients = document.getElementById("nav-patients-btn");
    var navSchedule = document.getElementById("nav-schedule-btn");

    if (currentUser) {
      userInfo.innerHTML =
        "ログイン中: " +
        currentUser.name +
        ' <span class="small-text">(' +
        currentUser.email +
        ")</span>";
      logoutBtn.style.display = "inline-flex";
      navDashboard.disabled = false;
      navPatients.disabled = false;
      navSchedule.disabled = false;
    } else {
      userInfo.textContent = "未ログイン";
      logoutBtn.style.display = "none";
      navDashboard.disabled = true;
      navPatients.disabled = true;
      navSchedule.disabled = true;
    }
  }

  function formatDateTime(str) {
    if (!str) return "";
    var d = new Date(str);
    if (isNaN(d.getTime())) return "";
    var yyyy = d.getFullYear();
    var mm = ("0" + (d.getMonth() + 1)).slice(-2);
    var dd = ("0" + d.getDate()).slice(-2);
    var hh = ("0" + d.getHours()).slice(-2);
    var mi = ("0" + d.getMinutes()).slice(-2);
    return yyyy + "/" + mm + "/" + dd + " " + hh + ":" + mi;
  }

  function formatTime(str) {
    if (!str) return "";
    var d = new Date(str);
    if (isNaN(d.getTime())) return "";
    var hh = ("0" + d.getHours()).slice(-2);
    var mi = ("0" + d.getMinutes()).slice(-2);
    return hh + ":" + mi;
  }

  function getPatientName(id) {
    for (var i = 0; i < appState.patients.length; i++) {
      if (appState.patients[i].id === id) {
        return appState.patients[i].lastName + " " + appState.patients[i].firstName;
      }
    }
    return "";
  }

  function goToDashboard() {
    renderDashboard();
    showView("view-dashboard");
  }

  // ======= ログイン =======
  function initLogin() {
    var form = document.getElementById("login-form");
    var errorEl = document.getElementById("login-error");
    var submitBtn = document.getElementById("login-submit-btn");
    var logoutBtn = document.getElementById("logout-btn");

    form.addEventListener("submit", function (e) {
      e.preventDefault();
      var email = document.getElementById("login-email").value.trim();
      var password = document.getElementById("login-password").value;
      errorEl.style.display = "none";

      if (!email || !password) {
        errorEl.style.display = "block";
        errorEl.textContent = "メールアドレスとパスワードを入力してください。";
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = "ログイン中...";

      setTimeout(function () {
        currentUser = {
          name: "デモ看護師",
          email: email
        };
        document.getElementById("login-password").value = "";
        submitBtn.disabled = false;
        submitBtn.textContent = "ログイン";
        updateHeader();
        alert("ログイン成功しました。ダッシュボードに移動します。");
        goToDashboard();
      }, 150);
    });

    logoutBtn.addEventListener("click", function () {
      currentUser = null;
      updateHeader();
      showView("view-login");
    });
  }

  // ======= ダッシュボード / スケジュール =======
  function renderDashboard() {
    var tbody = document.getElementById("dashboard-visits-body");
    tbody.innerHTML = "";
    var today = todayISODate();
    var visits = appState.visits.slice().sort(function (a, b) {
      return a.startAt > b.startAt ? 1 : -1;
    });

    var hasToday = false;
    for (var i = 0; i < visits.length; i++) {
      var v = visits[i];
      if ((v.startAt || "").slice(0, 10) !== today) continue;
      hasToday = true;

      var tr = document.createElement("tr");

      var tdTime = document.createElement("td");
      tdTime.textContent = formatTime(v.startAt) + "〜" + formatTime(v.endAt);
      tr.appendChild(tdTime);

      var tdName = document.createElement("td");
      tdName.textContent = getPatientName(v.patientId);
      tr.appendChild(tdName);

      var tdType = document.createElement("td");
      tdType.textContent =
        v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急";
      tr.appendChild(tdType);

      var tdNurse = document.createElement("td");
      tdNurse.textContent = v.nurse || "";
      tr.appendChild(tdNurse);

      var tdStatus = document.createElement("td");
      var span = document.createElement("span");
      span.className = "pill";
      span.textContent = v.status;
      tdStatus.appendChild(span);
      tr.appendChild(tdStatus);

      var tdAction = document.createElement("td");
      var btn = document.createElement("button");
      btn.className = "btn secondary small";
      btn.textContent = "記録入力";
      btn.addEventListener("click", (function (visitId, patientId) {
        return function () {
          currentPatientId = patientId;
          openVisitNote(visitId);
        };
      })(v.id, v.patientId));
      tdAction.appendChild(btn);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }

    if (!hasToday) {
      var trEmpty = document.createElement("tr");
      var tdEmpty = document.createElement("td");
      tdEmpty.colSpan = 6;
      tdEmpty.textContent = "本日の訪問予定はありません。";
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    }
  }

  function renderScheduleView() {
    var tbody = document.getElementById("schedule-table-body");
    var label = document.getElementById("schedule-date-label");
    var today = todayISODate();
    label.textContent = "対象日: " + today;
    tbody.innerHTML = "";

    var visits = appState.visits.slice().sort(function (a, b) {
      return a.startAt > b.startAt ? 1 : -1;
    });

    var hasToday = false;
    for (var i = 0; i < visits.length; i++) {
      var v = visits[i];
      if ((v.startAt || "").slice(0, 10) !== today) continue;
      hasToday = true;

      var tr = document.createElement("tr");

      var tdTime = document.createElement("td");
      tdTime.textContent = formatTime(v.startAt) + "〜" + formatTime(v.endAt);
      tr.appendChild(tdTime);

      var tdName = document.createElement("td");
      tdName.textContent = getPatientName(v.patientId);
      tr.appendChild(tdName);

      var tdType = document.createElement("td");
      tdType.textContent =
        v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急";
      tr.appendChild(tdType);

      var tdNurse = document.createElement("td");
      tdNurse.textContent = v.nurse || "";
      tr.appendChild(tdNurse);

      var tdStatus = document.createElement("td");
      var span = document.createElement("span");
      span.className = "pill";
      span.textContent = v.status;
      tdStatus.appendChild(span);
      tr.appendChild(tdStatus);

      var tdAction = document.createElement("td");
      var btn = document.createElement("button");
      btn.className = "btn secondary small";
      btn.textContent = "記録入力";
      btn.addEventListener("click", (function (visitId, patientId) {
        return function () {
          currentPatientId = patientId;
          openVisitNote(visitId);
        };
      })(v.id, v.patientId));
      tdAction.appendChild(btn);
      tr.appendChild(tdAction);

      tbody.appendChild(tr);
    }

    if (!hasToday) {
      var trEmpty = document.createElement("tr");
      var tdEmpty = document.createElement("td");
      tdEmpty.colSpan = 6;
      tdEmpty.textContent = "本日の訪問予定はありません。";
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    }
  }

  // ======= 利用者一覧 =======
  function renderPatientsList() {
    var tbody = document.getElementById("patients-table-body");
    var q = document.getElementById("patient-search").value.trim().toLowerCase();
    tbody.innerHTML = "";

    var items = appState.patients.slice().sort(function (a, b) {
      var na = a.lastName + a.firstName;
      var nb = b.lastName + b.firstName;
      return na > nb ? 1 : -1;
    });

    var found = false;
    for (var i = 0; i < items.length; i++) {
      var p = items[i];
      var nameLower = (p.lastName + p.firstName).toLowerCase();
      if (q && nameLower.indexOf(q) === -1) continue;
      found = true;

      var tr = document.createElement("tr");
      tr.style.cursor = "pointer";

      var tdName = document.createElement("td");
      tdName.textContent = p.lastName + " " + p.firstName;
      tdName.style.color = "#1976d2";
      tr.appendChild(tdName);

      var tdBirth = document.createElement("td");
      tdBirth.textContent = p.birthDate || "";
      tr.appendChild(tdBirth);

      var tdSex = document.createElement("td");
      tdSex.textContent =
        p.sex === "M" ? "男性" : p.sex === "F" ? "女性" : "";
      tr.appendChild(tdSex);

      var tdPhone = document.createElement("td");
      tdPhone.textContent = p.phone || "";
      tr.appendChild(tdPhone);

      tr.addEventListener("click", (function (id) {
        return function () {
          openPatientDetail(id);
        };
      })(p.id));

      tbody.appendChild(tr);
    }

    if (!found) {
      var trEmpty = document.createElement("tr");
      var tdEmpty = document.createElement("td");
      tdEmpty.colSpan = 4;
      tdEmpty.textContent = "該当する利用者がいません。";
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    }
  }

  function resetPatientForm() {
    document.getElementById("patient-id").value = "";
    document.getElementById("patient-last-name").value = "";
    document.getElementById("patient-first-name").value = "";
    document.getElementById("patient-birth-date").value = "";
    document.getElementById("patient-sex").value = "";
    document.getElementById("patient-phone").value = "";
    document.getElementById("patient-address").value = "";
    document.getElementById("patient-notes").value = "";
    document.getElementById("patient-form-title").textContent = "新規利用者登録";
    document.getElementById("patient-save-btn").textContent = "保存";
  }

  function initPatients() {
    document
      .getElementById("patient-search")
      .addEventListener("input", renderPatientsList);

    document
      .getElementById("btn-new-patient")
      .addEventListener("click", resetPatientForm);

    document
      .getElementById("patient-reset-btn")
      .addEventListener("click", resetPatientForm);

    document
      .getElementById("patient-form")
      .addEventListener("submit", function (e) {
        e.preventDefault();
        var id = document.getElementById("patient-id").value || genId();
        var lastName = document.getElementById("patient-last-name").value.trim();
        var firstName = document.getElementById("patient-first-name").value.trim();
        if (!lastName || !firstName) {
          alert("姓・名は必須です。");
          return;
        }
        var birthDate = document.getElementById("patient-birth-date").value || null;
        var sex = document.getElementById("patient-sex").value || "";
        var phone = document.getElementById("patient-phone").value || "";
        var address = document.getElementById("patient-address").value || "";
        var notes = document.getElementById("patient-notes").value || "";

        var updated = false;
        for (var i = 0; i < appState.patients.length; i++) {
          if (appState.patients[i].id === id) {
            appState.patients[i].lastName = lastName;
            appState.patients[i].firstName = firstName;
            appState.patients[i].birthDate = birthDate;
            appState.patients[i].sex = sex;
            appState.patients[i].phone = phone;
            appState.patients[i].address = address;
            appState.patients[i].notes = notes;
            updated = true;
            break;
          }
        }
        if (!updated) {
          appState.patients.push({
            id: id,
            lastName: lastName,
            firstName: firstName,
            birthDate: birthDate,
            sex: sex,
            phone: phone,
            address: address,
            notes: notes
          });
        }
        saveState();
        renderPatientsList();
        resetPatientForm();
        alert("利用者情報を保存しました。");
      });
  }

  // ======= 利用者詳細（訪問・バイタル） =======
  function switchPatientDetailTab(tabId) {
    var tabs = document.querySelectorAll("#view-patient-detail .tab");
    for (var i = 0; i < tabs.length; i++) {
      if (tabs[i].getAttribute("data-tab") === tabId) {
        tabs[i].classList.add("active");
      } else {
        tabs[i].classList.remove("active");
      }
    }
    var panels = document.querySelectorAll("#view-patient-detail .detail-tab");
    for (var j = 0; j < panels.length; j++) {
      panels[j].style.display = panels[j].id === tabId ? "block" : "none";
    }
  }

  function renderPatientDetailBasic() {
    var p = null;
    for (var i = 0; i < appState.patients.length; i++) {
      if (appState.patients[i].id === currentPatientId) {
        p = appState.patients[i];
        break;
      }
    }
    if (!p) return;
    document.getElementById("patient-detail-name").textContent =
      p.lastName + " " + p.firstName;
    document.getElementById("patient-detail-basic").textContent =
      "生年月日: " +
      (p.birthDate || "-") +
      " / 性別: " +
      (p.sex === "M" ? "男性" : p.sex === "F" ? "女性" : "-") +
      " / 電話: " +
      (p.phone || "-") +
      " / 住所: " +
      (p.address || "-");
  }

  function renderPatientVisits() {
    var tbody = document.getElementById("patient-visits-body");
    tbody.innerHTML = "";
    var visits = appState.visits.slice().sort(function (a, b) {
      return a.startAt > b.startAt ? -1 : 1;
    });

    var hasAny = false;
    for (var i = 0; i < visits.length; i++) {
      var v = visits[i];
      if (v.patientId !== currentPatientId) continue;
      hasAny = true;

      var tr = document.createElement("tr");

      var tdDate = document.createElement("td");
      tdDate.textContent = formatDateTime(v.startAt);
      tr.appendChild(tdDate);

      var tdType = document.createElement("td");
      tdType.textContent =
        v.type === "regular" ? "定期" : v.type === "oncall" ? "オンコール" : "緊急";
      tr.appendChild(tdType);

      var tdNurse = document.createElement("td");
      tdNurse.textContent = v.nurse || "";
      tr.appendChild(tdNurse);

      var tdStatus = document.createElement("td");
      var span = document.createElement("span");
      span.className = "pill";
      span.textContent = v.status;
      tdStatus.appendChild(span);
      tr.appendChild(tdStatus);

      var tdAction = document.createElement("td");
      var btnEdit = document.createElement("button");
      btnEdit.className = "btn secondary small";
      btnEdit.textContent = "編集";
      btnEdit.addEventListener("click", (function (visit) {
        return function () {
          document.getElementById("visit-id").value = visit.id;
          document.getElementById("visit-date").value = visit.startAt
            ? visit.startAt.slice(0, 10)
            : "";
          var dt = visit.startAt ? new Date(visit.startAt) : null;
          var et = visit.endAt ? new Date(visit.endAt) : null;
          document.getElementById("visit-start-time").value = dt
            ? dt.toISOString().slice(11, 16)
            : "";
          document.getElementById("visit-end-time").value = et
            ? et.toISOString().slice(11, 16)
            : "";
          document.getElementById("visit-type").value = visit.type || "regular";
          document.getElementById("visit-nurse").value = visit.nurse || "";
          document.getElementById("visit-memo").value = visit.memo || "";
        };
      })(v));
      tdAction.appendChild(btnEdit);

      var btnNote = document.createElement("button");
      btnNote.className = "btn secondary small";
      btnNote.textContent = "記録入力";
      btnNote.style.marginLeft = "4px";
      btnNote.addEventListener("click", (function (visitId) {
        return function () {
          openVisitNote(visitId);
        };
      })(v.id));
      tdAction.appendChild(btnNote);

      tr.appendChild(tdAction);
      tbody.appendChild(tr);
    }

    if (!hasAny) {
      var trEmpty = document.createElement("tr");
      var tdEmpty = document.createElement("td");
      tdEmpty.colSpan = 5;
      tdEmpty.textContent = "訪問予定・実績はまだ登録されていません。";
      trEmpty.appendChild(tdEmpty);
      tbody.appendChild(trEmpty);
    }
  }

  function resetVisitForm() {
    document.getElementById("visit-id").value = "";
    document.getElementById("visit-date").value = todayISODate();
    document.getElementById("visit-start-time").value = "09:00";
    document.getElementById("visit-end-time").value = "09:30";
    document.getElementById("visit-type").value = "regular";
    document.getElementById("visit-nurse").value = currentUser
      ? currentUser.name
      : "";
    document.getElementById("visit-memo").value = "";
  }

  function renderPatientVitals() {
    var tbody = document.getElementById("vitals-table-body");
    tbody.innerHTML = "";
    var vitals = appState.vitals.slice().sort(function (a, b) {
      return a.measuredAt > b.measuredAt ? -1 : 1;
    });

    for (var i = 0; i < vitals.length; i++) {
      var v = vitals[i];
      if (v.patientId !== currentPatientId) continue;

      var tr = document.createElement("tr");

      var tdDt = document.createElement("td");
      tdDt.textContent = formatDateTime(v.measuredAt);
      tr.appendChild(tdDt);

      var tdTemp = document.createElement("td");
      tdTemp.textContent = v.temp != null ? v.temp.toFixed(1) : "";
      tr.appendChild(tdTemp);

      var tdBp = document.createElement("td");
      tdBp.textContent =
        (v.bpSys != null ? v.bpSys : "") +
        "/" +
        (v.bpDia != null ? v.bpDia : "");
      tr.appendChild(tdBp);

      var tdPulse = document.createElement("td");
      tdPulse.textContent = v.pulse != null ? v.pulse : "";
      tr.appendChild(tdPulse);

      var tdSpo2 = document.createElement("td");
      tdSpo2.textContent = v.spo2 != null ? v.spo2 : "";
      tr.appendChild(tdSpo2);

      tbody.appendChild(tr);
    }

    renderVitalsChart();
  }

  function renderVitalsChart() {
    var canvas = document.getElementById("vitals-chart");
    if (!canvas || typeof Chart === "undefined") return;
    var ctx = canvas.getContext("2d");

    var vitals = appState.vitals.slice().sort(function (a, b) {
      return a.measuredAt > b.measuredAt ? 1 : -1;
    });

    var labels = [];
    var temps = [];
    for (var i = 0; i < vitals.length; i++) {
      var v = vitals[i];
      if (v.patientId !== currentPatientId || v.temp == null) continue;
      var d = new Date(v.measuredAt);
      labels.push(
        (d.getMonth() + 1) +
          "/" +
          d.getDate() +
          " " +
          ("0" + d.getHours()).slice(-2) +
          ":" +
          ("0" + d.getMinutes()).slice(-2)
      );
      temps.push(v.temp);
    }

    if (vitalsChart) {
      vitalsChart.destroy();
      vitalsChart = null;
    }
    if (labels.length === 0) return;

    vitalsChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [
          {
            label: "体温(℃)",
            data: temps,
            tension: 0.3
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            suggestedMin: 35,
            suggestedMax: 40
          }
        }
      }
    });
  }

  function openPatientDetail(patientId) {
    currentPatientId = patientId;
    renderPatientDetailBasic();
    renderPatientVisits();
    renderPatientVitals();
    switchPatientDetailTab("detail-visits");
    showView("view-patient-detail");
  }

  function initPatientDetail() {
    var tabs = document.querySelectorAll("#view-patient-detail .tab");
    for (var i = 0; i < tabs.length; i++) {
      (function (tab) {
        tab.addEventListener("click", function () {
          var id = tab.getAttribute("data-tab");
          switchPatientDetailTab(id);
          if (id === "detail-vitals") {
            renderPatientVitals();
          } else if (id === "detail-visits") {
            renderPatientVisits();
          }
        });
      })(tabs[i]);
    }

    document
      .getElementById("btn-new-visit")
      .addEventListener("click", resetVisitForm);
    document
      .getElementById("visit-reset-btn")
      .addEventListener("click", resetVisitForm);

    document.getElementById("visit-form").addEventListener("submit", function (e) {
      e.preventDefault();
      if (!currentPatientId) {
        alert("利用者が選択されていません。");
        return;
      }
      var id = document.getElementById("visit-id").value || genId();
      var date = document.getElementById("visit-date").value;
      var startTime = document.getElementById("visit-start-time").value;
      var endTime = document.getElementById("visit-end-time").value;

      if (!date || !startTime) {
        alert("日付と開始時刻は必須です。");
        return;
      }
      var type = document.getElementById("visit-type").value || "regular";
      var nurse =
        document.getElementById("visit-nurse").value ||
        (currentUser ? currentUser.name : "");
      var memo = document.getElementById("visit-memo").value || "";

      var startAt = new Date(date + "T" + startTime + ":00");
      var endAt = endTime ? new Date(date + "T" + endTime + ":00") : null;

      var updated = false;
      for (var i = 0; i < appState.visits.length; i++) {
        if (appState.visits[i].id === id) {
          appState.visits[i].patientId = currentPatientId;
          appState.visits[i].startAt = startAt.toISOString();
          appState.visits[i].endAt = endAt ? endAt.toISOString() : null;
          appState.visits[i].type = type;
          appState.visits[i].nurse = nurse;
          appState.visits[i].memo = memo;
          updated = true;
          break;
        }
      }
      if (!updated) {
        appState.visits.push({
          id: id,
          patientId: currentPatientId,
          startAt: startAt.toISOString(),
          endAt: endAt ? endAt.toISOString() : null,
          type: type,
          nurse: nurse,
          status: "scheduled",
          memo: memo
        });
      }
      saveState();
      renderPatientVisits();
      renderDashboard();
      alert("訪問予定を保存しました。");
      resetVisitForm();
    });

    document.getElementById("vital-form").addEventListener("submit", function (e) {
      e.preventDefault();
      if (!currentPatientId) {
        alert("利用者が選択されていません。");
        return;
      }
      var dt = document.getElementById("vital-datetime").value;
      if (!dt) {
        alert("測定日時は必須です。");
        return;
      }
      var temp = parseFloat(document.getElementById("vital-temp").value);
      var bpSys = parseInt(document.getElementById("vital-bp-sys").value, 10);
      var bpDia = parseInt(document.getElementById("vital-bp-dia").value, 10);
      var pulse = parseInt(document.getElementById("vital-pulse").value, 10);
      var spo2 = parseInt(document.getElementById("vital-spo2").value, 10);

      appState.vitals.push({
        id: genId(),
        patientId: currentPatientId,
        visitId: currentVisitId || null,
        measuredAt: new Date(dt).toISOString(),
        temp: isNaN(temp) ? null : temp,
        bpSys: isNaN(bpSys) ? null : bpSys,
        bpDia: isNaN(bpDia) ? null : bpDia,
        pulse: isNaN(pulse) ? null : pulse,
        spo2: isNaN(spo2) ? null : spo2
      });
      saveState();
      renderPatientVitals();
      alert("バイタルを追加しました。");
      e.target.reset();
    });
  }

  // ======= 訪問記録 =======
  function openVisitNote(visitId) {
    currentVisitId = visitId;
    var visit = null;
    for (var i = 0; i < appState.visits.length; i++) {
      if (appState.visits[i].id === visitId) {
        visit = appState.visits[i];
        break;
      }
    }
    var patient = null;
    if (visit) {
      for (var j = 0; j < appState.patients.length; j++) {
        if (appState.patients[j].id === visit.patientId) {
          patient = appState.patients[j];
          break;
        }
      }
    }
    var header = document.getElementById("visit-note-header");
    if (visit && patient) {
      header.textContent =
        patient.lastName +
        " " +
        patient.firstName +
        " / " +
        formatDateTime(visit.startAt);
      currentPatientId = patient.id;
    } else {
      header.textContent = "";
    }
    var note = null;
    for (var k = 0; k < appState.visitNotes.length; k++) {
      if (appState.visitNotes[k].visitId === visitId) {
        note = appState.visitNotes[k];
        break;
      }
    }
    document.getElementById("note-subjective").value = note ? note.subjective : "";
    document.getElementById("note-objective").value = note ? note.objective : "";
    document.getElementById("note-assessment").value = note ? note.assessment : "";
    document.getElementById("note-plan").value = note ? note.plan : "";
    document.getElementById("note-free").value = note ? note.freeText : "";
    showView("view-visit-note");
  }

  function initVisitNote() {
    document.getElementById("visit-note-form").addEventListener("submit", function (e) {
      e.preventDefault();
      if (!currentVisitId || !currentPatientId) {
        alert("訪問情報が見つかりません。");
        return;
      }
      var subjective = document.getElementById("note-subjective").value;
      var objective = document.getElementById("note-objective").value;
      var assessment = document.getElementById("note-assessment").value;
      var plan = document.getElementById("note-plan").value;
      var freeText = document.getElementById("note-free").value;

      var found = false;
      for (var i = 0; i < appState.visitNotes.length; i++) {
        if (appState.visitNotes[i].visitId === currentVisitId) {
          appState.visitNotes[i].subjective = subjective;
          appState.visitNotes[i].objective = objective;
          appState.visitNotes[i].assessment = assessment;
          appState.visitNotes[i].plan = plan;
          appState.visitNotes[i].freeText = freeText;
          appState.visitNotes[i].updatedAt = new Date().toISOString();
          found = true;
          break;
        }
      }
      if (!found) {
        appState.visitNotes.push({
          id: genId(),
          visitId: currentVisitId,
          patientId: currentPatientId,
          subjective: subjective,
          objective: objective,
          assessment: assessment,
          plan: plan,
          freeText: freeText,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        });
      }
      saveState();
      alert("訪問記録を保存しました。");
      if (currentPatientId) {
        openPatientDetail(currentPatientId);
      } else {
        goToDashboard();
      }
    });

    document.getElementById("btn-note-back").addEventListener("click", function () {
      if (currentPatientId) {
        openPatientDetail(currentPatientId);
      } else {
        goToDashboard();
      }
    });
  }

  // ======= ナビゲーション =======
  function initNavigation() {
    document
      .getElementById("nav-dashboard-btn")
      .addEventListener("click", goToDashboard);
    document
      .getElementById("nav-patients-btn")
      .addEventListener("click", function () {
        renderPatientsList();
        showView("view-patients");
      });
    document
      .getElementById("nav-schedule-btn")
      .addEventListener("click", function () {
        renderScheduleView();
        showView("view-schedule");
      });

    document
      .getElementById("nav-dashboard-to-patients")
      .addEventListener("click", function () {
        renderPatientsList();
        showView("view-patients");
      });
    document
      .getElementById("nav-dashboard-to-schedule")
      .addEventListener("click", function () {
        renderScheduleView();
        showView("view-schedule");
      });

    document
      .getElementById("btn-schedule-back")
      .addEventListener("click", goToDashboard);
  }

  // ======= 初期化：ここで必ず実行 =======
  function initApp() {
    try {
      initLogin();
      initPatients();
      initPatientDetail();
      initVisitNote();
      initNavigation();
      updateHeader();
      renderDashboard();
    } catch (e) {
      alert("初期化時にエラーが発生しました: " + e.message);
      console.error(e);
    }
  }

  // スクリプトが body の末尾にあるので、DOM 構築後に必ず実行される
  initApp();
</script>
</body>
</html>
